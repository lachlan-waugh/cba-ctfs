<!doctype html><html lang=en><head><meta charset=utf-8><title>heap</title>
<meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../reveal-js/css/reset.css><link rel=stylesheet href=../reveal-js/css/reveal.css><link rel=stylesheet href=../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section data-noprocess data-shortcode-slide class=center><h2 id=allocator-exploitation>allocator exploitation</h2><h3 id=lunch--learn>lunch & learn</h3></section><section><h3 id=overview>overview</h3><ul><li>what is a heap</li><li>malloc basics</li><li>use after free</li><li>double free</li><li>applications</li></ul></section><section><section data-shortcode-section><h3 id=what-is-the-heap>what is the heap</h3><ul><li><p>section of memory for</p><ul><li>long living stuff</li><li>stuff you don&rsquo;t know the size of at compile time</li></ul></li><li><p>stack is used for short lived stuff (e.g. local variables for a function)</p></li></ul></section><section><h3 id=memory-stuff>memory stuff</h3></section><section><h3 id=when-are-they-used>when are they used</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>do_stuff</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;                  <span style=color:#75715e>// stored on the stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>)) <span style=color:#75715e>// stored on the heap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// i disappears at the end of the do stuff function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// j doesn&#39;t, it needs to be explicitly free()&#39;d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p> </p><blockquote><p>also in python</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>   <span style=color:#75715e># stored on stack</span>
</span></span><span style=display:flex><span>j <span style=color:#f92672>=</span> []  <span style=color:#75715e># stored on heap </span>
</span></span></code></pre></div></section></section><section><section data-shortcode-section><h3 id=what-is-malloc>what is malloc</h3><p>memory allocation</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>));
</span></span><span style=display:flex><span><span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>int</span>));
</span></span></code></pre></div><p> </p><p>returns a <strong>chunk</strong> of memory of the requested size</p></section><section><h3 id=free>free</h3><p>the opposite of malloc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(pointer)
</span></span></code></pre></div><ul><li>given a pointer, give it back to the allocator</li><li>mark it as free (set some metadata)</li><li>puts it in a specific bin depending on size</li></ul></section><section><h3 id=bins>bins</h3><p>linked lists of freed chunks</p><ul><li>when a chunk gets freed, it gets put in the bin</li><li>when the allocator wants a chunk, it looks in the bin</li></ul></section><section><h3 id=types-of-bins>types of bins</h3><ul><li>fast-bins</li><li>unsorted bins</li><li>small bins</li><li>large bins</li><li>tcache bins</li></ul></section><section><h3 id=inuse-chunks>inuse chunks</h3></section><section><h3 id=free-chunk>free chunk</h3></section></section><section><section data-shortcode-section><h2 id=exploitation>exploitation</h2><ul><li>the location that used to store user-controlled data, now stores control data (e.g. pointers!)</li><li>could we somehow overwrite that data?<ul><li>forward/back pointer</li><li>chunk size</li></ul></li></ul></section><section><h2 id=heap-overflow>heap overflow</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>[ <span style=color:#ae81ff>000000F</span> ] <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>0000000</span> ] <span style=color:#f92672>&gt;</span> <span style=color:#75715e>// chunk 1 (in use)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>[ <span style=color:#ae81ff>0000000</span> ] <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>000000F</span> ] }
</span></span><span style=display:flex><span>[ <span style=color:#ae81ff>0000000</span> ] } <span style=color:#75715e>// chunk 2 (free)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>[ <span style=color:#ae81ff>0000000</span> ] }
</span></span></code></pre></div><blockquote><p>if you could write enough into chunk 1, you could overwrite content in chunk 2</p></blockquote></section><section><h2 id=heap-overflow-1>heap overflow</h2><p>if you wrote <code>A</code> x <code>8</code> + <code>B</code> x <code>12</code> into a chunk of size <code>4</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span>[ <span style=color:#ae81ff>000000F</span> ] <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>[ AAAAAAA ] <span style=color:#f92672>&gt;</span> <span style=color:#75715e>// chunk 1 (in use)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>[ AAAAAAA ] <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>[ BBBBBBB ] }
</span></span><span style=display:flex><span>[ BBBBBBB ] } <span style=color:#75715e>// chunk 2 (free)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>[ BBBBBBB ] }
</span></span></code></pre></div></section><section><h2 id=use-after-free>use after free</h2><p>free doesn&rsquo;t actually NULL out the reference</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>string <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>));
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;string = %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, string);
</span></span><span style=display:flex><span><span style=color:#75715e>// string = 0x5da5101
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>free</span>(string);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;string = %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, string);
</span></span><span style=display:flex><span><span style=color:#75715e>// string = 0x5da5101
</span></span></span></code></pre></div></section><section><h3 id=forging-chunks>forging chunks</h3><p>manipulate the metadata of the chunk after its freed</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(chunk)     <span style=color:#75715e>// bin: chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>*</span>chunk <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AAAA&#34;</span> <span style=color:#75715e>// bin: chunk -&gt; 0x41414141 -&gt; ????
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(...)     <span style=color:#75715e>// bin: 0x41414141 -&gt; ????
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(...)     <span style=color:#75715e>// bin: ????
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the second call to malloc returns 0x41414141
</span></span></span></code></pre></div></section><section><h2 id=double-free>double free</h2><p>what if we free()&rsquo;d the same chunk twice?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#a6e22e>free</span>(chunk)     <span style=color:#75715e>// bin: chunk -&gt; NULL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>free</span>(chunk)     <span style=color:#75715e>// bin: chunk -&gt; chunk -&gt; chunk -&gt; ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>malloc</span>(...)     <span style=color:#75715e>// bin: chunk -&gt; chunk -&gt; chunk -&gt; ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>malloc</span>(...)     <span style=color:#75715e>// bin: chunk -&gt; chunk -&gt; chunk -&gt; ...
</span></span></span></code></pre></div></section><section><h2 id=demo>demo</h2></section><section><h3 id=realism>realism</h3><p>a struct with a function pointer isn&rsquo;t that realistic, but..</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=nohighlight data-noescape><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>user_t</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> level;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_name</span>(<span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>user_t</span> <span style=color:#f92672>*</span>user) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fgets</span>(user<span style=color:#f92672>-&gt;</span>name, <span style=color:#ae81ff>100</span>, stdin);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><blockquote><p>arbitary writes</p></blockquote></section></section><section><section data-shortcode-section><h2 id=other-types>other types</h2><ul><li>unlink exploit</li><li>shrinking free chunks</li><li>enlarging free chunks</li><li>house of spirit</li><li>house of lore</li><li>house of force</li><li>house of einherjar</li></ul><blockquote><p>uhh a lot more</p></blockquote></section></section><section><h3 id=relevance-in-other-languages>relevance in other languages</h3><ul><li><a href=https://pwn.win/2022/05/11/python-buffered-reader.html>UAF in Python</a></li><li><a href=https://github.com/advisories/GHSA-524r-c4hc-2m74>Double free in Chrome</a></li><li><a href=https://github.com/golang/go/issues/35777>UAF in Golang</a></li></ul><blockquote><p>python is just fancy C</p></blockquote></section><section><h3 id=questions>questions?</h3></section></div></div><script type=text/javascript src=../reveal-hugo/object-assign.js></script><a href=../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>null</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../reveal-js/plugin/notes/notes.js></script></body></html>